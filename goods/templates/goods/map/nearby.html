{% extends '_base.html' %}
{% load staticfiles %}
{% load cloudinary %}
{% block beginjs %}
<script type="text/javascript" 
	src=https://maps.googleapis.com/maps/api/js?key=AIzaSyDZTlXL-J2h0DQO0CVDpXbtKOtn_TTCZTU&sensor=true>
</script>
{% endblock %}
{% block content %}
<div class="container">
    <div class="row" style="margin-top: 40px;">
          <div class="col-sm-12 product-description" style="width:100%">
              <div id="map-canvas"> </div>
          </div>
      </div>
</div>

<div class="container">
  <h4>A few local items you might like...</h4>
    <table class="table">
    	{% for product in products %}
  		<tr> 
  			<td><h4><b>{{ forloop.counter }}{{ '. '}}</b>{{ product.short_name }}</h4>
          <a href="{% url 'goods:detail' product.id %}">
            {% cloudinary product.productimage_set.first.image width=150 height=150 crop="fit" %}</a>
        </td>
  			<td class="dist"><h4><a href="{% url 'goods:storeprofile' product.store.id %}">{{ product.store.retailer }}</a></h4>{{ product.store.street }}</td>
  		</tr>
		{% endfor %}
    </table>
</div>
{% endblock %}
{% block endjs %}
<script type="text/javascript"> 
	function  getpoints (userloc) {
    var products = {{ products_json|safe }};
    var userloc = {
     'lat': userloc.coords.latitude,
     'lng': userloc.coords.longitude,
    };
      
      var userpos = new google.maps.LatLng(userloc.lat, userloc.lng);
      initialize(products, userloc);
      for (i in products) {
        add_dists(userpos,products[i],i);
      } 
    };

  function initializemap (products, userpos) {        
    var mapOptions = {
      center: userpos,
      zoom: 12
    };
    var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions); 
    var UserPin = new google.maps.Marker({
        position: userpos,
        map: map,
        title: 'You'
      });
    for (i in products) {
      var productpos = new google.maps.LatLng(products[i].fields.lat, products[i].fields.lng);
      var pinCounter = parseInt(i)+1;
      var homeMarker = new google.maps.Marker({
            position: productpos,
            map: map,
            icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld='+pinCounter+'|FF0000|000000',
            title: products[i].fields.short_name
      });
     };
  };

  function add_dists(userpos, prod, prodnum) {
    var productpos = new google.maps.LatLng(prod.fields.lat, prod.fields.lng);
    var request = {
          origin: userpos,
          destination: productpos,
          travelMode: google.maps.TravelMode.DRIVING
      };
    var directionsService = new google.maps.DirectionsService();
    directionsService.route(request, function(result, status) {
          if (status == google.maps.DirectionsStatus.OK) {
          }
          $(".dist").eq(prodnum).append('</br>('+result.routes[0].legs[0].distance.text+')');
        });
  };
	navigator.geolocation.getCurrentPosition(getpoints);
</script>
{% endblock %}